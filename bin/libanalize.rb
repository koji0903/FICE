#!/usr/bin/ruby
#############################################################
#
# libanalize
#  - Analize lib file generated by make_chip
#  
#  Author     : Koji HIJIKURO<koji.hijikuro@necel.com>
#
############################################################
#
# [OPERATION]
#  Analize lib file genereated by make_chip for Synthesis.
#  Lib file consisted include description, So this tool operate
#  analizing include path and copy target file to local directory.
#
#  If there is a file including "`include" in the extension of the 
#  file, this file is progressed.
#
# [USAGE]
#  %libanalize.rb -lib <LibFile> -top <Top File> -prj <ProjectName> -outdir <OutputDirectory>
#
# [EXAMPLE]
#  %check_log.rb make_chip.log
#
# [OUTPUT]
#  - _src/{HDL Files}
#  - Project File for Synplify Pro
#
###################################################################
$:.unshift(File.dirname(__FILE__) + "/../lib")
require "FICE_def"
require "system"
require "common"
require "fileutils"
require "synthesis"

$SUB_TOOL       = "libanalize"
Version    = $VERSION

$LIB_FILE   = nil
$TOP_FILE   = nil
$PROJECT    = nil
$TOP_MODULE = nil   # = $PROJECT

$SRC        = "_src"

# For synthesis
$WORK_DIR   = "work"
$FILE       = Array.new
$SDC        = Array.new
$TECHNOLOGY = "Virtex4"
$PART       = "XC4VLX80"
$PACKAGE    = "FF1148"
$SPEED_GRADE = "-10"

$ERROR_CNT   = 0
$WARNING_CNT = 0

class LibAnalize < Synthesis
  #
  # initialize
  #
  def initialize
    @FileData = Array.new
  end

  #
  # print base
  #
  def print_base
    printf("%s ver:%s\n",$TOOL,$VERSION)
    printf("Copyright (c) 2009 NEC MicroSystem. All rights reserved.\n\n")
  end
  
  #
  # print ussage
  #
  def print_usage
    printf("\n")
    printf("Usage :  %s.rb  -lib <LibFile> -top <Top File> -prj <ProjectName>\n",$TOOL)
    printf(" OPTION\n")
    printf("    -h/-help     : print help message\n")
    printf("    -v/-version  : print version\n")
    printf("    -verbose     : execute on verbose mode\n")
    printf("    \n")
  end


  # 
  #  Get Argument
  #
  def get_argument
    size = ARGV.size
    size -= 1
    for i in 0..size
      case ARGV[i]
      when '-h','-help' then
        print_base
        print_usage
        exit
      when '-v','-version' then
        print_base
        printf("")
        exit
      when '-verbose' then
        $VERBOSE = true
      when '-lib' then
        $LIB_FILE = ARGV[i+1]
        i += 1
      when '-top' then
        $TOP_FILE = ARGV[i+1]
        i += 1
      when '-prj' then
        $PROJECT = ARGV[i+1]
        $TOP_MODULE = ARGV[i+1]
        i += 1
      when '-outdir' then
        $SRC = ARGV[i+1]
        i += 1
      else
        if /^-/ =~ ARGV[i]
          printf("[E] %s option is not supported.\n",ARGV[i])
          print_usage
          exit
        end
      end 
    end

      

    # Argument Check
    if $LIB_FILE == nil
      $ERROR_CNT += 1
      printf("@E:Option setting is not enough\n")
      print_usage
      Common.print_summary
      exit
    end
  end

  def read
    @FileData = Common.file_read("#{$LIB_FILE}")
  end
  
  def analize

    # Copy TOP_FILE
    if $TOP_FILE != nil
      FileUtils::install($TOP_FILE,$SRC + "/" + $TOP_FILE, :mode=> 0700)
      $FILE << "../" + $SRC + "/" + $TOP_FILE
    end
    
    # Copy LIB_FILE
    @FileData.each{|line|
      if /^`include/ =~ line
        /\"(.*)\"/ =~ line
        target = $1

        # If the file name is "*.include*"
        if /.*\.include.*$/ =~ target
          printf("@I:Found include file, so this file is progresed\n")
          include_file = Array.new
          include_file = Common.file_read("#{target}")
          include_file.each{|line2|
            if /include/ =~ line2
              /\"(.*)\"/ =~ line2
              target2 = $1
              # Copy file
              if File::exists?(target2) == true
                printf("Copied %s\n",target2)
                FileUtils::install(target2,$SRC + "/" + File.basename(target2), :mode=> 0700)
                $FILE << "../" + $SRC + "/" + File.basename(target2)
              end
            end
          }
          printf("@I:sub include file operation end\n")
        else
          # Copy file
          if File::exists?(target) == true
            printf("Copied %s\n",target)
            FileUtils::install(target,$SRC + "/" + File.basename(target), :mode=> 0700)
            $FILE << "../" + $SRC + "/" + File.basename(target)
          end
        end
      end
      $FILE.uniq! 
      $FILE.delete("../_src/icedly50n.hdl_080912")
    }
  end

  #
  # exe
  #
  def exe
    get_argument
    Common.print_base
    Common.make_dir("#{$SRC}")
    Common.make_dir("#{$WORK_DIR}")
    read
    analize
    # Synthesis
    if  $PROJECT != nil
      gen_prj("#{$PROJECT}.prj")
    end
    Common.print_summary
  end
end

libana = LibAnalize.new
libana.exe
